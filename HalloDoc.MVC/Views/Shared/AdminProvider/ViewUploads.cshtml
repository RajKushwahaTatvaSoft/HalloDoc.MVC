@model ViewUploadsViewModel
@{
    string layoutName = "";
    string controller = "";
    if (Model.IsAdmin)
    {
        layoutName = "_AdminDashboardLayout";
        controller = "Admin";
    }
    else
    {
        layoutName = "_PhysicianDashboardLayout";
        controller = "Physician";
    }
}
@{
    Layout = layoutName;
}

<div class="tab-content px-4" id="myTabContent">
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">

        <div class="container-fluid d-flex justify-content-center row ">

            <div class="col-8">

                <div class="d-flex justify-content-between mt-5">
                    <h4>Documents</h4>

                    <button class="btn btn-outline-info align-middle" onclick="history.back(-1)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#01bce9" width="15" height="15" viewBox="0 -960 960 960">
                            <path d="m142-480 294 294q15 15 14.5 35T435-116q-15 15-35 15t-35-15L57-423q-12-12-18-27t-6-30q0-15 6-30t18-27l308-308q15-15 35.5-14.5T436-844q15 15 15 35t-15 35L142-480Z" />
                        </svg>
                        <span>Back</span>
                    </button>


                </div>

                <form method="post" enctype="multipart/form-data">

                    <div class="shadow p-3 dashboard-card mt-4">

                        <input asp-for="RequestId" hidden />
                        <h6>@Model.PatientName</h6>
                        <div class="d-flex align-items-end">
                            @* <h4 class="text-info">@Model.Firstname @Model.Lastname</h4> *@
                            <h5 class="ms-2">(@Model.ConfirmationNumber)</h5>
                        </div>
                        <span>Check here for any files that you or the doctors of your subsequents requestors have attached for you to review.</span>

                        <div class="row mt-2 mx-1">

                            <input asp-for="File" class="form-control" type="file" id="file_input_id" style="display:none;">

                            <div class="input-group mb-3">
                                <input type="text" id='text_input_id' class="form-control" placeholder="Select File"
                                       style="caret-color: transparent" autocomplete="off">

                                <span class="input-group-text" id="text_input_span_id " style="background-color: #10bce9;">
                                    <label for="text_input_span_id">
                                        <button style="background-color: #10bce9; border: none;" type="submit">
                                            <img src="/images/upload_icon.svg" alt="upload-icon">
                                            <span class="ms-1 text-white">Upload</span>
                                        </button>
                                    </label>
                                </span>

                            </div>

                        </div>

                        <div class="d-flex justify-content-between mt-2">

                            <h4>Documents</h4>

                            <div>

                                <button type="button" class="btn btn-outline-info shadow-none night-mode-btn" id="delete-all-btn">
                                    <span>Delete All</span>
                                </button>

                                <a asp-controller="@controller" asp-action="DownloadAllFiles" asp-route-requestId="@Model.RequestId" class="btn ms-2 btn-outline-info shadow-none night-mode-btn">
                                    <span>Download All</span>
                                </a>

                                <button type="button" class="btn ms-2 btn-outline-info shadow-none night-mode-btn" id="send-mail-btn">
                                    <span>Send Mail</span>
                                </button>
                            </div>

                        </div>

                        <div class="mt-3">
                            <table class="table">
                                <colgroup>
                                    <col span="1" style="width: 30%;">
                                    <col span="1" style="width: 30%;">
                                    <col span="1" style="width: 30%;">
                                    <col span="1" style="width: 10%;">
                                </colgroup>

                                <thead class="table-head align-middle">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="select-all-checkbox">
                                        </th>
                                        <th>Document</th>
                                        <th>Upload Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="table-body align-middle">
                                    @for (int i = 0; i < Model.requestwisefiles.Count; i++)
                                    {
                                        <tr class="table-row">
                                            <td>
                                                <input class="check" value="@Model.requestwisefiles[i].Requestwisefileid" type="checkbox">
                                            </td>
                                            <td>
                                                <div>
                                                    @{
                                                        string ext = Model.extensions[i];
                                                    }
                                                    @if (ext.Equals(".pdf"))
                                                    {
                                                        <svg height="20px" width="20px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                                             viewBox="0 0 309.267 309.267" xml:space="preserve"><g>
                                                        <path style="fill:#E2574C;" d="M38.658,0h164.23l87.049,86.711v203.227c0,10.679-8.659,19.329-19.329,19.329H38.658 c-10.67,0-19.329-8.65-19.329-19.329V19.329C19.329,8.65,27.989,0,38.658,0z" />
                                                        <path style="fill:#B53629;" d="M289.658,86.981h-67.372c-10.67,0-19.329-8.659-19.329-19.329V0.193L289.658,86.981z" />
                                                        <path style="fill:#FFFFFF;" d="M217.434,146.544c3.238,0,4.823-2.822,4.823-5.557c0-2.832-1.653-5.567-4.823-5.567h-18.44 c-3.605,0-5.615,2.986-5.615,6.282v45.317c0,4.04,2.3,6.282,5.412,6.282c3.093,0,5.403-2.242,5.403-6.282v-12.438h11.153 c3.46,0,5.19-2.832,5.19-5.644c0-2.754-1.73-5.49-5.19-5.49h-11.153v-16.903C204.194,146.544,217.434,146.544,217.434,146.544z M155.107,135.42h-13.492c-3.663,0-6.263,2.513-6.263,6.243v45.395c0,4.629,3.74,6.079,6.417,6.079h14.159 c16.758,0,27.824-11.027,27.824-28.047C183.743,147.095,173.325,135.42,155.107,135.42z M155.755,181.946h-8.225v-35.334h7.413 c11.221,0,16.101,7.529,16.101,17.918C171.044,174.253,166.25,181.946,155.755,181.946z M106.33,135.42H92.964 c-3.779,0-5.886,2.493-5.886,6.282v45.317c0,4.04,2.416,6.282,5.663,6.282s5.663-2.242,5.663-6.282v-13.231h8.379 c10.341,0,18.875-7.326,18.875-19.107C125.659,143.152,117.425,135.42,106.33,135.42z M106.108,163.158h-7.703v-17.097h7.703 c4.755,0,7.78,3.711,7.78,8.553C113.878,159.447,110.863,163.158,106.108,163.158z" /></g>
                                                        </svg>
                                                    }
                                                    else if (ext.Equals(".png") || ext.Equals(".jpg") || ext.Equals(".jpeg"))
                                                    {
                                                        <img height="20px" width="20px" src="~/images/image_logo.png" />
                                                    }
                                                    else
                                                    {
                                                        <svg height="20px" width="20px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                                             viewBox="0 0 309.267 309.267" xml:space="preserve"><g>
                                                        <path style="fill:#10bce9;" d="M38.658,0h164.23l87.049,86.711v203.227c0,10.679-8.659,19.329-19.329,19.329H38.658 c-10.67,0-19.329-8.65-19.329-19.329V19.329C19.329,8.65,27.989,0,38.658,0z" />
                                                        <path style="fill:#10ffee;" d="M289.658,86.981h-67.372c-10.67,0-19.329-8.659-19.329-19.329V0.193L289.658,86.981z" />
                                                        <path style="fill:#FFFFFF;" d="M217.434,146.544c3.238,0,4.823-2.822,4.823-5.557c0-2.832-1.653-5.567-4.823-5.567h-18.44 c-3.605,0-5.615,2.986-5.615,6.282v45.317c0,4.04,2.3,6.282,5.412,6.282c3.093,0,5.403-2.242,5.403-6.282v-12.438h11.153 c3.46,0,5.19-2.832,5.19-5.644c0-2.754-1.73-5.49-5.19-5.49h-11.153v-16.903C204.194,146.544,217.434,146.544,217.434,146.544z M155.107,135.42h-13.492c-3.663,0-6.263,2.513-6.263,6.243v45.395c0,4.629,3.74,6.079,6.417,6.079h14.159 c16.758,0,27.824-11.027,27.824-28.047C183.743,147.095,173.325,135.42,155.107,135.42z M155.755,181.946h-8.225v-35.334h7.413 c11.221,0,16.101,7.529,16.101,17.918C171.044,174.253,166.25,181.946,155.755,181.946z M106.33,135.42H92.964 c-3.779,0-5.886,2.493-5.886,6.282v45.317c0,4.04,2.416,6.282,5.663,6.282s5.663-2.242,5.663-6.282v-13.231h8.379 c10.341,0,18.875-7.326,18.875-19.107C125.659,143.152,117.425,135.42,106.33,135.42z M106.108,163.158h-7.703v-17.097h7.703 c4.755,0,7.78,3.711,7.78,8.553C113.878,159.447,110.863,163.158,106.108,163.158z" /></g>
                                                                                                                </svg>
                                                    }
                                                    <span>@Model.requestwisefiles[i].Filename</span>
                                                </div>
                                            </td>
                                            <td>@Model.requestwisefiles[i].Createddate.ToString("MMM dd, yyyy")</td>
                                            <td class="text-info">
                                                <a id="@i" href="/document/request/@Model.RequestId/@Model.requestwisefiles[i].Filename" class="btn px-2 py-1 btn-outline-info shadow-none night-mode-btn" download>

                                                    <svg class="mobile" xmlns="http://www.w3.org/2000/svg" height="24" fill="#01bce9" viewBox="0 -960 960 960" width="24">
                                                        <path d="M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q17-72 85-137t145-65q33 0 56.5 23.5T520-716v242l64-62 56 56-160 160-160-160 56-56 64 62v-242q-76 14-118 73.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h480q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-48-22-89.5T600-680v-93q74 35 117 103.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H260Zm220-358Z" />
                                                    </svg>

                                                </a>

                                                @{
                                                    string deleteId = "delete: " + i;
                                                }

                                                <button type="button" onclick="deleteFile(@Model.requestwisefiles[i].Requestwisefileid)" class="btn ms-1 px-2 py-1 btn-outline-info shadow-none night-mode-btn">

                                                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                                                        <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
                                                    </svg>

                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </form>

                <div style="height: 20px;"></div>

            </div>

        </div>

    </div>
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
        <span>Profile</span>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous">
</script>

<script>

    $('.admin-tab').removeClass("active");
    $('#dashboard-tab').addClass("active");

</script>

<script>

    $("#select-all-checkbox").click(function () {
        $('input:checkbox').not(this).prop('checked', this.checked);
    });

    $(".check:checkbox").click(function () {
        if (!this.checked) {
            console.log("set false");
            $("#select-all-checkbox").prop('checked', false);
        }
        else if ($(".check:checkbox").length == $(".check:checked").length) {
            console.log("set true");
            $("#select-all-checkbox").prop('checked', true);
        }
    });

</script>

<script>
    var profile = document.getElementById("profile-tab");
    var dashboard = document.getElementById("dashboard-tab");

    dashboard.classList.add("active");
    profile.classList.remove("active");
</script>

<script>

    function deleteFile(fileId) {
        $.ajax({
            url: "/@controller/DeleteFile",
            data: { requestWiseFileId: fileId },
            type: 'POST',
            success: function (result) {
                location.reload();
            },
            error: function (error) {
                console.log(error);
                alert('Error Cancelling Request')
            },
        });
    }

    $('#send-mail-btn').click(function () {

        let selectedFiles = [];
        let checkboxes = document.querySelectorAll(".check");

        $("input:checkbox:checked").each(function () {
            selectedFiles.push($(this).val());
        });

        $.ajax({
            url: "/@controller/SendFilesViaMail",
            type: 'POST',
            data: { fileIds: selectedFiles, requestId: @Model.RequestId },
            success: function (result) {
                location.reload();
            },
            error: function (error) {
                console.log(error);
                alert('Error Cancelling Request')
            },
        });
    });

    $('#delete-all-btn').click(function () {
        $.ajax({
            url: "/@controller/DeleteAllFiles",
            data: { requestId: @Model.RequestId },
            type: 'POST',
            success: function (result) {
                location.reload();
            },
            error: function (error) {
                console.log(error);
                alert('Error Cancelling Request')
            },
        });
    });

    document.getElementById("download-selected-btn").addEventListener("click", function () {

        let selectedFiles = [];
        let checkboxes = document.querySelectorAll(".check");
        let count = 0;
        console.log("download-selected");

        checkboxes.forEach(function (checkbox) {
            if (checkbox.checked) {
                selectedFiles.push(count);
                console.log(count);
            }
            count++;
        });

        selectedFiles.forEach(function (index) {
            document.getElementById(index).click();
        });

    });

</script>

<script>

    $('#text_input_id').click(function () {
        $("#file_input_id").trigger('click');
    })

    $("#file_input_id").change(function () {
        $('#text_input_id').val(this.value.replace(/C:\\fakepath\\/i, ''))
    })
</script>
